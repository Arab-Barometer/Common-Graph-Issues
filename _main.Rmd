--- 
title: "Common Arab Barometer Graph Problems and How to (Mostly) Solve Them"
author: "MaryClare Roche"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography: [book.bib, packages.bib]
# url: your book url like https://bookdown.org/yihui/bookdown
# cover-image: path to the social sharing image like images/cover.jpg
description: |
  This is a reference for issues that commonly occur when using the ArabBarometR package, or creating graphs for Arab Barometer in general.
link-citations: yes
github-repo: rstudio/bookdown-demo
---

# About {-}

This guide is meant to help address common problems users run into with the `ArabBarometR` package. Examples in this guide use data from Arab Barometer Wave VII.


```{r load-data, include=FALSE,cache=TRUE}
library(ArabBarometR)
library(dplyr)
library(ggplot2)

abwave7_eng <- haven::read_dta("/Volumes/GoogleDrive/Shared drives/Arab Barometer/AB7/Data/RELEASE_DATA/Latest/AB7_ENG_Release_V8.dta")

abwave7_ara <- haven::read_dta("/Volumes/GoogleDrive/Shared drives/Arab Barometer/AB7/Data/RELEASE_DATA/Latest/AB7_ARA_Release_V8.dta")


trend_data_ENG <- haven::read_dta("/Volumes/GoogleDrive/Shared drives/Arab Barometer/AB7/Data Books/MEPI_Data_Book_Code/Trend Data/EnglishTrend.dta")

all_waves_ENG <- trend_data_ENG %>%
  split(f = .$WAVE)

trend_data_ARA <- haven::read_dta("/Volumes/GoogleDrive/Shared drives/Arab Barometer/AB7/Data Books/MEPI_Data_Book_Code/Trend Data/ArabicTrend.dta")

all_waves_ARA <- trend_data_ARA %>%
  split(f = .$WAVE)

```

<!--chapter:end:index.Rmd-->

# Title & Subtitle Issues {#title-issues}

```{r include=FALSE}
library(ArabBarometR)
```

Title and subtitle issues often go hand-in-hand, and the process for solving them is often the same, so both will be addressed here. As shorthand, the guide will use "title" in place of "title and subtitle" unless otherwise explicitly stated.

-   [Title is not showing up](#no-title)
-   [Title is wrong](#wrong-title)
-   Title does not fit on graph
-   Title does not display correctly due to language issues
-   Only title or only subtitle is showing up

## Title/subtitle is not showing up {#no-title}

There are a few reasons a graph's title may not appear. In order from most to least likely, it could be:

-   [the question number for the summary is wrong](#wrong-numb-user);
-   [the question number in the titles reference sheet is wrong](#wrong-num-titlesheet);
-   [the question number does not have a title in the titles reference sheet](#wrong-num-titlesheet);
-   [the function does not automatically supply a title for the graph](#no-auto-title); or
-   [the default has been changes from `.title = TRUE` to `.title = FALSE`](#default-change).

### Wrong Question Number, User Error {#wrong-numb-user}

The first step is to check if you are summarizing the correct question. You may automatically think, *``Of course I'm summarizing the correct question! I'm the one who's deciding which question to summarize! I'm going to skip this section!''* 

Please don't.

This is most often the case when trying to create a comparative plot for the first category of a nominal question. For example, say you want to the percent of the population who said the economic situation was the most pressing issue facing their country across countries. You might type the following:

```{r no-title-1,error=TRUE, fig.dim=c(13,12)}

# English
calculate_smry_comp(abwave7_eng,
                    "Q2061A") %>%
  plot_smry_comp(.caption = "Arab Barometer Wave VII (2021-2022)",
                 .language = "en")

# Arabic
calculate_smry_comp(abwave7_ara,
                    "Q2061A") %>%
  plot_smry_comp(.caption = "Arab Barometer Wave VII (2021-2022)",
                 .language = "ar")

```

You get a graph and the numbers are correct. What gives?

What gives is that `Q2061A` is a **nominal question**. The summary functions in the `ArabBarometR` package only summarize the response values of `1` for nominal questions. You see the correct values because you are comparing the first category.

How do you know the type of question you are trying to plot? One rule of thumb is that if the question is not on a scale and has multiple different choices, it's probably nominal. Another way to tell is to use the handy `type_test()` function provided by the `ArabBarometR` package. The only input is a character string of the variable. The function outputs the type that variable is classified as.

```{r no-title-2}

type_test("Q2061A")

```

Ok, so then why don't you see a title? You don't see a title because this is a nominal question *and* a comparative graph. The titles sheet that `ArabBarometR` uses to call titles for **comparative** plots expects all nominal questions to be dummied out. That is, if variable `Q999` is a nominal question with `N` categories, there is a comparative title for `Q999_1`, `Q999_2`, ... , `Q999_N`. There is NOT a comparative title for `Q999`.

**How to Fix It** Now that you know why the title isn't showing up, you probably have a good idea of how to fix it.

1.  Make sure your nominal variable is dummied out.
2.  Re-do your code with the correct variable name.

The `ArabBarometR` package provides two useful methods for creating dummies: `dummy_all()` and `dummy_select()`. The `dummy_all()` function will create a dummy variable for every level of the original variable. The `dummy_select()` function will create a dummy variable for a specific level of the original variable. That is, `dummy_all(abwave7,Q999)` and `dummy_select(abwave7,Q999,.dmy_lvl = 1)` will both create the variable `Q999_1`, but only `dummy_all()` will create `Q999_2` through `Q999_N`.

Below we can see what happens when we correct our code.

```{r no-title-3, fig.dim=c(13,12)}

# English
abwave7_eng <- dummy_all(abwave7_eng,Q2061A)

calculate_smry_comp(abwave7_eng,
                    "Q2061A_1") %>%
  plot_smry_comp(.caption = "Arab Barometer Wave VII (2021-2022)",
                 .language = "en")

# Arabic
abwave7_ara <- dummy_all(abwave7_ara,Q2061A)

calculate_smry_comp(abwave7_ara,
                    "Q2061A_1") %>%
  plot_smry_comp(.caption = "Arab Barometer Wave VII (2021-2022)",
                 .language = "ar")
```

Fixed!

### Wrong Question Number, Titles Sheet Errors I & II {#wrong-num-titlesheet}

Ok, so what if you're not trying to create a comparative plot for a nominal question and there's still no title? Then it's time to look at whether there is an issue with the titles sheet. It could be that (1) the question number in the reference sheet is incorrect or (2) there is no title associated with that question number.

The first step is to verify that there is no title associated with the question number you are trying to graph, regardless of *why* there is no title. This can be done using the `title_function()` and `subtitle_function()` from the `ArabBarometR` package. These functions are primarily used internally in the `plot_` functions to call up titles and subtitles, but they can also be used on the front-end to verify titles.

These functions take four inputs:

1. `.title`/`.subtitle` : A title the user wants to use OR a logical value indicating whether a title should be returned automatically; i.e., the title/subtitle is expected to be in the titles sheet.
2. `.var` : The question number as a character string; e.g., `"Q999"`.
3. `.language` : Either `"English"` or `"Arabic"` depending on the language of the graph.
4. `.graph_type` : Either `"individual"` or `"comparative"` depending on the type of graph you want to make.

You can use these functions to see why no title was provided in the example for section \@ref(wrong-numb-user). Before the corrections were made, the `plot_smry_comp()` function was doing the following internally:

```{r no-title-4}

# English
title_function(TRUE,             # Automatically supply the title
               "Q2061A",         # Look for the title for variable Q2061A
               "English",        # Provide the English title
               "comparative")    # For a comparative graph

subtitle_function(TRUE,             # Automatically supply the subtitle
                  "Q2061A",         # Look for the subtitle for variable Q2061A
                  "English",        # Provide the English subtitle
                  "comparative")    # For a comparative graph


# Arabic
title_function(TRUE,             # Automatically supply the title
               "Q2061A",         # Look for the title for variable Q2061A
               "Arabic",         # Provide the Arabic title
               "comparative")    # For a comparative graph

subtitle_function(TRUE,             # Automatically supply the subtitle
                  "Q2061A",         # Look for the subtitle for variable Q2061A
                  "Arabic",         # Provide the Arabic subtitle
                  "comparative")    # For a comparative graph

```

The functions return no value because there is no `Q2061A` in the comparative titles sheet. Once the question number was corrected, the `plot_smry_comp()` was instead doing the following internally:

```{r no-title-5}

# English
title_function(TRUE,             # Automatically supply the title
               "Q2061A_1",       # Look for the title for variable Q2061A
               "English",        # Provide the English title
               "comparative")    # For a comparative graph

subtitle_function(TRUE,             # Automatically supply the subtitle
                  "Q2061A_1",       # Look for the subtitle for variable Q2061A
                  "English",        # Provide the English subtitle
                  "comparative")    # For a comparative graph


# Arabic
title_function(TRUE,             # Automatically supply the title
               "Q2061A_1",       # Look for the title for variable Q2061A
               "Arabic",         # Provide the Arabic title
               "comparative")    # For a comparative graph

subtitle_function(TRUE,             # Automatically supply the subtitle
                  "Q2061A_1",       # Look for the subtitle for variable Q2061A
                  "Arabic",         # Provide the Arabic subtitle
                  "comparative")    # For a comparative graph

```

If you use the functions and don't get a value, that variable (spelled as-is) does not have a title. This could be for the reason listed above: (1) the variable is incorrectly named in the reference sheet, or (2) the variable is not in the reference sheet.

**How to Fix It**

*Short Term*: For a graph you need immediately, you can supply your own title and subtitle. In every `plot_` function, there is a `.title` and `.subtitle` parameter that can be used just like the `.caption` parameter. That is, the user supplies a string for each parameter and those strings become the title and subtitle.

*Long Term*: For a permanent fix, first identify if the title is missing/misspelled from the `ArabBarometR` package, the latest Google Drive titles sheet, or both.

In the package, there are four title data frames: `titles_comparative_ar`, `titles_single_country_ar`, `titles_comparative_en`, and `titles_single_country_en`. These data frames contain all the Arabic comparative titles, Arabic single country titles, English comparative titles, and English single country titles, respectively. You can use `View(dataframe)` to look at the data frames.

Currently, the location of the titles sheet on Google Drive will likely depend on the Wave.^[Hopefully in the future there will be one master titles sheet we add to each Wave as necessary.]

The package draws the titles from the sheet on Google Drive. Let the team know you are making updates to the titles sheet on the Google Drive, for which question, why, and when you are finished with the corrections. Once the corrections are done, MC will update the package.

### No Automatic Title/Subtitle {#no-auto-title}

There are a few functions which do not automatically supply a title. This is common for functions that plot multiple question, as the package cannot anticipate every combination of questions that could be plotted together. This will also happen if you create your own variable to graph. In these cases, the onus is on the user to supply a title.

For example, say you wanted to make a comparative graph showing the percent of citizens who say the current economic situation in their country is bad or very bad (`Q101`, response values 3 and 4). The default settings for this question would produce the opposite: the percent of citizens who say the current economic situation in their country is good or very good. The most straightforward way to create this graph is to create a new variable and plot that.

```{r no-title-6, fig.dim=c(13,12)}

abwave7_eng$bad_economy <- ifelse(abwave7_eng$Q101 %in% 3:4, 1, 0)

calculate_smry_comp(abwave7_eng,
                    "bad_economy",
                    .type = "dichotomous") %>%
  plot_smry_comp(.caption = "Arab Barometer Wave VII (2021-2022)",
                 .language = "en")

```

Essentially, inside the `plot_smry_comp()` function, the functions `title_function()` and `subtitle_function()` are once again returning nothing, since the variable "bad_economy" is not in the title data frames.

**How to Fix It** In this case, you must supply your own title. This is a feature that will remain constant. It is unreasonable to expect the package to predict exactly what kind of custom graphs you will produce. Just remember to include a title!

```{r no-title-7}

abwave7_eng$bad_economy <- ifelse(abwave7_eng$Q101 %in% 3:4, 1, 0)

calculate_smry_comp(abwave7_eng,
                    "bad_economy",
                    .type = "dichotomous") %>%
  plot_smry_comp(.title = "How is the economy doing in your country?",
                 .subtitle = "% saying bad or very bad",
                 .caption = "Arab Barometer Wave VII (2021-2022)",
                 .language = "en")

```

### Default Change {#default-change}

Finally, it could be that the default setting for supplying a title has changed. By default, every `plot_` function for which a title can be automatically supplied^[See section \@ref(no-auto-title) for why not every function can supply a title.], does automatically supply a title.

Although it is extremely unlikely, it could be that the `ArabBarometR` default changed so `plot_` functions no longer supply a title. If this is the case, a warning has certainly gone out that this change is coming/has come and a note has been made in the record of `ArabBarometR` versioning. To check the default setting of a function, view that function's help page. You can do this by typing `?function_name()` in your R console. On the help page, look for what the `.title` parameter is set to. If you see `.title = F` or `.title = FALSE`, the default has changed so the function no longer automatically supplies the title.

```{r no-title-8}

?plot_smry_comp

```

It could also be that perhaps you turned off the default to check something else when debugging and forgot to switch it back. In this case, you would have explicitly set the `.title` parameter to `FALSE`.


```{r no-title-9, fig.dim=c(13,12)}

# English
calculate_smry_comp(abwave7_eng,
                    "Q2061A_1") %>%
  plot_smry_comp(.title = FALSE,
                 .subtitle = F,
                 .caption = "Arab Barometer Wave VII (2021-2022)",
                 .language = "en")

```

**How to Fix It** Set the `.title` and/or `.subtitle` parameter to `TRUE` or `T`.


```{r no-title-10, fig.dim=c(13,12)}

# English
calculate_smry_comp(abwave7_eng,
                    "Q2061A_1") %>%
  plot_smry_comp(.title = FALSE,
                 .subtitle = T,
                 .caption = "Arab Barometer Wave VII (2021-2022)",
                 .language = "en")

```

## Title/Subtitle is Wrong {#wrong-title}

<!--chapter:end:title-issues.Rmd-->

# Arabic Issues - Package {#arabic-issues-package}

It is a well-documented fact that R (and computers in general), are racist. This leads to many, many issues in the creation of Arabic graphs. Worse, issues are often OS-specific. This chapter reviews issues and solutions you may run into when using the `plot_` functions provided by the `AarbBarometR` package to create a graph in Arabic. Chapter \@ref(arabic-translation) reviews how to "translate" a graph from English to Arabic, emphasizing common points at which you may run into trouble.

<!--chapter:end:arabic-issues-package.Rmd-->

# Translating Arabic Plots {#arabic-translation}

This chapter reviews how to "translate" custom English plots to custom Arabic plots, and emphasizes points at which you may run into trouble. It is unreasonable to try to predict all custom plots, but regardless of the exact type of plot, there are certain consistencies we can still review. If you are having an issue with creating an Arabic plot with one of the `plot_` functions from the `ArabBarometR` package, please see Chapter \@ref(arabic-issues-package).

For this chapter, we are going to create a dumbbell plot showing the change in views regarding women in politics overtime. This graph cannot be created with the `ArabBarometR` package. It must be created "by hand". The graph will first be created in English, then translated into Arabic^[A note on English graph prioritization: Creating graphs in English first (and English being the default in the `ArabBarometR` package) is useful because the proof-of-concept should address the easiest case first. Arabic graphs are trickier than English graphs. If we cannot create the graph in English, it is unlikely we will be able to create the graph in Arabic. This should not be seen as a preference for English graphs at Arab Barometer, rather as a consequence of R's fundamental catering towards Western European culture.].

This is NOT meant to be a guide or reference for creating dumbbell plots. The goal is to highlight necessary changes when translating a graph from English to Arabic. Therefore, the section demonstrating the code for an English graph will have minimal instruction. The English code simply serves as a reference for the Arabic section.

Furthermore, since this is a demonstration graph and is not being used in production, we do not need to discuss the merits of design choices here. There are a number of different ways to visualize this data, but that is not the point of this chapter. The point of this chapter is to see how English graphs can be translated into Arabic.

## English Code


### Create a Data Frame

The first step for any plot is to create the data frame you wish to plot. Since we are comparing data from the first two waves to wave seven, we need to load and subset the trend data.


```{r arabic-tranlation-1, eval=FALSE}

trend_data_ENG <- haven::read_dta("path/to/trend/data")

all_waves_ENG <- trend_data_ENG %>%
  split(f = .$WAVE)

```

Now we have a list of data frames according to wave, stored in the variable `all_waves_ENG`.

The next step is to calculate the summary of `Q601_3` by country for each wave. We can do that using the `calculate_smry_comp()` function from the `ArabBarometR` package.

```{r arabic-translation-2}
wave7_Q6013 <- abwave7_eng %>%
  calculate_smry_comp("Q601_3") %>%
  mutate(Wave = "VII") %>%
  mutate(Country = as.character(Country))

wave1_Q6013 <- all_waves_ENG$`1` %>%
  calculate_smry_comp("Q601_3") %>%
  mutate(Wave = "I") %>%
  mutate(Country = as.character(Country))

wave2_Q6013 <- all_waves_ENG$`2` %>%
  calculate_smry_comp("Q601_3") %>%
  mutate(Wave = "II") %>%
  mutate(Country = as.character(Country))
```

Currently, there is no way to distinguish which summaries belong to which wave. Every data frame has one column names `Country` and one column named `Q601_3`. Let's add a distinguishing column. Also, to save ourselves a headache later, let's convert `Country` from a labelled double to a character.

```{r arabic-translation-3}
wave7_Q6013 <- wave7_Q6013 %>%
  mutate(Wave = "VII",
         Country = as.character(Country))

wave1_Q6013 <- wave1_Q6013 %>%
  mutate(Wave = "I",
         Country = as.character(Country)) 

wave2_Q6013 <- wave2_Q6013 %>%
  mutate(Wave = "II",
         Country = as.character(Country))
```

Some countries were surveyed both in Wave I and Wave II. We only want to compare the earliest point at which the country is surveyed to the latest point at which the country was surveyed. Thus, we filter out countries from Wave II which appeared in Wave I.


```{r arabic-translations-4}
early_waves <- rbind(wave1_Q6013,
                     wave2_Q6013)  %>%
  group_by(Country) %>%
  slice(1) %>%
  ungroup()
```

Now, we know some countries were surveyed in Wave VII that were not surveyed in Waves I or II. Similarly, some countries were surveyed in Waves I or II but not in Wave VII. We cannot compare the responses from Wave VII to Wave I or II if the country was not surveyed, so we need to limit our summaries to countries which were surveys in Wave VII and Wave I or II.

```{r arabic-translations-5}
countries <- intersect(wave7_Q6013$Country,
                       early_waves$Country)

wave7_Q6013 <- wave7_Q6013 %>%
  filter(Country %in% countries)

early_waves <- early_waves %>%
  filter(Country %in% countries)
```

The (nearly) last step is to combine the `early_waves` data frame and the `wave7_Q6013` data frame, and re-order the columns (why we want to re-order the columns will become clear in a moment).

```{r arabic-translation-6}
Q6013_trend <- rbind(wave7_Q6013,
                      early_waves) %>%
  relocate(Wave, .before = Q601_3)
```

With this data frame, we can use the `plot_demographic_smry_comp()` function from the `ArabBarometR` package. The order of the columns matters for this function. The `plot_demographic_smry_comp()` function expects output in the same form the `calculate_demographic_smry_comp()` function outputs. That is, the columns from left to right should be a country column, a demographic column, and a percent column. That is the order of `Q6013_trend`, so we can plug it into `plot_demographic_smry_comp()`.

```{r arabic-translation-7, fig.dim=c(13,12)}

plot_demographic_smry_comp(Q6013_trend,
                           .caption = "Arab Barometer Waves I, II, VII",
                           .language = "en")

```

But this chapter is not for `plot_` functions from the `ArabBarometR` package, so let's continue.

Before creating the dumbbell plot for `Q6013_trend`, let's do one more calculation that will allow us to include arrows pointing in the direction of opinion change over the years.

```{r arabic-translation-8}
Q6013_trend <- Q6013_trend %>%
  tidyr::pivot_wider(names_from = "Wave",
                     values_from = "Q601_3") %>%
  mutate(one2seven = abs(VII - I)/2 + pmin(VII,I),
         two2seven = abs(VII - II)/2 + pmin(VII,II),
         midpoint = coalesce(one2seven,two2seven)) %>%
  select(!c(one2seven,two2seven)) %>%
  tidyr::pivot_longer(cols = c(VII,II,I),
                      names_to = "Wave",
                      values_to = "Q601_3") %>%
  filter(!is.na(Q601_3))
```

Now, we are ready to create our dumbbell plot.

### Plot the Data Frame

There will not be a detailed explanation of what each line of the code does to plot the data. The point of this chapter is not to explain how to create dumbbell plots. The point is to re-create a custom English plot in Arabic.

```{r arabic-translations-9, fig.dim=c(13,12)}

# Data Frame:
Q6013_trend %>% 
  
  # ggplot base
  ggplot(aes(x = Q601_3, y = reorder(Country,Q601_3))) +
  
  # ggplot line for connecting the points
  geom_line(aes(group = Country),
            color = "#545454") +
  
  # ggplot arrow pointing in the direction of change
  geom_segment(data = ~subset(.x, Wave == "I"|Wave == "II"), 
               aes(
                 x = midpoint,
                 xend = midpoint + .5 * sign(midpoint - Q601_3), 
                 yend = Country), 
               arrow = arrow(angle = 30, length = unit(.1, "inches"), type = "closed"), 
               color = "#545454") +
  
  # ggplot points
  geom_point(aes(color = Wave),
             size = 8) +
  
  # setting the colors of the points
  scale_color_manual(values = c("#0098BE","#7CBBC7","#DF6E21"))+
  
  # adding the percent value to the points
  geom_text(aes(label = ifelse(Q601_3 == 0, "<1", Q601_3),
                family = 'Montserrat'),
            color = "white",
            fontface = "bold",
            size = 4,
            position = position_dodge(width = 1)) +
  
  # showing the whole scale from 0 to 100
  scale_x_continuous(limits = c(0,100)) +
  
  # adding a title and subtitle
  labs(
    title = stringr::str_wrap(
      title_function(TRUE,
                     "Q601_3",
                     "English",
                     "comparative"),
      50),
    subtitle = subtitle_function(TRUE,
                                 "Q601_3",
                                 "English",
                                 "comparative"),
    caption = "Arab Barometer Wave I, II, VII"
  ) +
  
  # using the Arab Barometer branded theme
  theme_ab_english()


```

## Arabic Code

Again, the first step is to create the data frame we want to plot, this time with the Arabic data.

### Create a Data Frame

```{r arabic-translation-11, fig.dim=c(13,12),eval=FALSE}

trend_data_ARA <- haven::read_dta("path/to/trend/data")

all_waves_ARA <- trend_data_ARA %>%
  split(f = .$WAVE)

```

Since the process for creating the data frame is the same, regardless of language, all of it is presented here succinctly.

```{r arabic-translation-12, fig.dim=c(13,12)}

wave7_Q6013 <- abwave7_ara %>%
  calculate_smry_comp("Q601_3") %>%
  mutate(Wave = "VII") %>%
  mutate(Country = as.character(Country))

wave1_Q6013 <- all_waves_ARA$`1` %>%
  calculate_smry_comp("Q601_3") %>%
  mutate(Wave = "I") %>%
  mutate(Country = as.character(Country))

wave2_Q6013 <- all_waves_ARA$`2` %>%
  calculate_smry_comp("Q601_3") %>%
  mutate(Wave = "II") %>%
  mutate(Country = as.character(Country))

early_waves <- rbind(wave1_Q6013,
                     wave2_Q6013)  %>%
  group_by(Country) %>%
  slice(1) %>%
  ungroup()

countries <- intersect(wave7_Q6013$Country,
                       early_waves$Country)

wave7_Q6013 <- wave7_Q6013 %>%
  filter(Country %in% countries)

early_waves <- early_waves %>%
  filter(Country %in% countries)

Q6013_trend <- rbind(wave7_Q6013,
                      early_waves) %>%
  relocate(Wave, .before = Q601_3) %>%
  tidyr::pivot_wider(names_from = "Wave",
                     values_from = "Q601_3") %>%
  mutate(one2seven = abs(VII - I)/2 + pmin(VII,I),
         two2seven = abs(VII - II)/2 + pmin(VII,II),
         midpoint = coalesce(one2seven,two2seven)) %>%
  select(!c(one2seven,two2seven)) %>%
  tidyr::pivot_longer(cols = c(VII,II,I),
                      names_to = "Wave",
                      values_to = "Q601_3") %>%
  filter(!is.na(Q601_3))
```

Now for plotting.

### Plot the Data Frame

Unlike creating the data frame, you cannot simply plug the Arabic data frame in for the English data frame and call it a day. The code below is exactly the code from creating the English graph, only the Arabic data frame is being piped in. The code chunk is numbered. When referencing lines of code, this is the code chunk being referred to.

```{r arabic-translations-13, fig.dim=c(13,12), attr.source='.numberLines',eval=FALSE}

# Data Frame:
Q6013_trend %>% 
  
  # ggplot base
  ggplot(aes(x = Q601_3, y = reorder(Country,Q601_3))) +
  
  # ggplot line for connecting the points
  geom_line(aes(group = Country),
            color = "#545454") +
  
  # ggplot arrow pointing in the direction of change
  geom_segment(data = ~subset(.x, Wave == "I"|Wave == "II"), 
               aes(
                 x = midpoint,
                 xend = midpoint + .5 * sign(midpoint - Q601_3), 
                 yend = Country), 
               arrow = arrow(angle = 30, length = unit(.1, "inches"), type = "closed"), 
               color = "#545454") +
  
  # ggplot points
  geom_point(aes(color = Wave),
             size = 8) +
  
  # setting the colors of the points
  scale_color_manual(values = c("#0098BE","#7CBBC7","#DF6E21"))+
  
  # adding the percent value to the points
  geom_text(aes(label = ifelse(Q601_3 == 0, "<1", Q601_3),
                family = 'Montserrat'),
            color = "white",
            fontface = "bold",
            size = 4,
            position = position_dodge(width = 1)) +
  
  # showing the whole scale from 0 to 100
  scale_x_continuous(limits = c(0,100)) +
  
  # adding a title and subtitle
  labs(
    title = stringr::str_wrap(
      title_function(TRUE,
                     "Q601_3",
                     "English",
                     "comparative"),
      50),
    subtitle = subtitle_function(TRUE,
                                 "Q601_3",
                                 "English",
                                 "comparative"),
    caption = "Arab Barometer Wave I, II, VII"
  ) +
  
  # using the Arab Barometer branded theme
  theme_ab_english()


```

```{r arabic-translation-23, fig.dim=c(13,12),echo=FALSE}
knitr::include_graphics("Untranslated_Arabic_Graph.png")
```

#### English to Arabic Text {-}

There are several obvious issues with the graph. Most blatantly, the title, subtitle, and caption are in English. This is changed by changing lines 40 - 50.

```{r arabic-translation-14,eval=FALSE}
# English Titles
title = stringr::str_wrap(
  title_function(TRUE,
                 "Q601_3",
                 "English",
                 "comparative"),
  50),
subtitle = subtitle_function(TRUE,
                             "Q601_3",
                             "English",
                             "comparative"),
caption = "Arab Barometer Wave I, II, VII"

# Arabic Titles
title = stringr::str_wrap(
  title_function(TRUE,
                 "Q601_3",
                 "Arabic",
                 "comparative"),
  60),
subtitle = subtitle_function(TRUE,
                             "Q601_3",
                             "Arabic",
                             "comparative"),
caption = "الباروميتر العربي"

```

Of course, this is only if you want to use a "pre-made" title. If you are coming up with your own title, you do not have to use the title and subtitle functions.

```{r arabic-translation-15,eval=FALSE}
# Arabic Titles
title = stringr::str_wrap(
  "الرجال أفضل في تولي القيادة السياسية من النساء",
  50),
subtitle = "% من يقولون أتفق بشدة أو أتفق مع هذه العبارة",
caption = "الباروميتر العربي"

```

#### Right to Left {-}

Arabic graphs are read right to left, so the x- and y-axis labels must be reflected.

To change the direction of the x-axis, we must change line 36.

```{r arabic-translation-16,eval=FALSE}

# English x-axis
scale_x_continuous(limits = c(0,100))

# Arabic x-axis
scale_x_reverse(limits = c(100,0))

```

To change the y-axis labels, we need to add a line.

```{r arabic-translations-17,eval=FALSE}

# Arabic y-axis
scale_y_discrete(position = "right")

```

#### Point Labels {-}

A subtle change in English to Arabic graphs it the font. The AB brand font for English is Montserrat, and the brand font for Arabic is Tajawal. While the font for the text is controlled by the theme (discussed in the following section), the labels on the graph are separate. The code defining the labels on the graph is found on lines 28-33.

```{r arabic-translation-18,eval=FALSE}

# English
geom_text(aes(label = ifelse(Q601_3 == 0, "<1", Q601_3),
                family = 'Montserrat'),
            color = "white",
            fontface = "bold",
            size = 4,
            position = position_dodge(width = 1))

# Arabic
geom_text(aes(label = ifelse(Q601_3 == 0, "1>", Q601_3),
                family = 'Tajawal'),
            color = "white",
            fontface = "bold",
            size = 4,
            position = position_dodge(width = 1))

```

Aside from changing the font, the direction of the "less than" sign is also changed.

#### Arabic Theme {-}

Finally, the `ArabBarometR` package provides separate ggplot themes for English and Arabic graphs. The theme controls the font, size, and placement of title elements. See line 54.

```{r arabic-translation-19,eval=FALSE}

# English
theme_ab_english()

# Arabic
theme_ab_arabic()

```

With that, we can translate the graph.

### Translated Graph

```{r arabic-translation-20, fig.dim=c(13,12),echo=FALSE}

reverse_sentence <- function(str1){
  paste(rev(strsplit(str1, "\\s+")[[1]]), collapse= " ")
}

arabic_title <- title_function(TRUE,
                     "Q601_3",
                     "Arabic",
                     "comparative")
arabic_title <- reverse_sentence(arabic_title)

arabic_subtitle <- subtitle_function(TRUE,
                     "Q601_3",
                     "Arabic",
                     "comparative")
arabic_subtitle <- stringr::str_remove(arabic_subtitle," %")
arabic_subtitle <- reverse_sentence(arabic_subtitle)
arabic_subtitle <- paste0(arabic_subtitle," %")
```



```{r arabic-translation-21, fig.dim=c(13,12),eval=FALSE}
Q6013_trend %>% 
  
  # ggplot base
  ggplot(aes(x = Q601_3, y = reorder(Country,Q601_3))) +
  
  # ggplot line for connecting the points
  geom_line(aes(group = Country),
            color = "#545454") +
  
  # ggplot arrow pointing in the direction of change
  geom_segment(data = ~subset(.x, Wave == "I"|Wave == "II"), 
               aes(
                 x = midpoint,
                 xend = midpoint + .5 * sign(midpoint - Q601_3), 
                 yend = Country), 
               arrow = arrow(angle = 30, length = unit(.1, "inches"), type = "closed"), 
               color = "#545454") +
  
  # ggplot points
  geom_point(aes(color = Wave),
             size = 8) +
  
  # setting the colors of the points
  scale_color_manual(values = c("#0098BE","#7CBBC7","#DF6E21"))+
  
  # adding the percent value to the points
  geom_text(aes(label = ifelse(Q601_3 == 0, "1>", Q601_3),
                family = 'Tajawal'),
            color = "white",
            fontface = "bold",
            size = 4,
            position = position_dodge(width = 1)) +
  
  # showing the whole scale from 0 to 100
  scale_x_reverse(limits = c(100,0)) +
  scale_y_discrete(position = "right") +
  
  # adding a title and subtitle
  labs(
    title = stringr::str_wrap(
      arabic_title,
      60),
    subtitle = arabic_subtitle,
    caption = "الباروميتر العربي"
  ) +
  
  theme_ab_arabic()


```


```{r arabic-translation-22, fig.dim=c(13,12),echo=FALSE}
knitr::include_graphics("Translated_Arabic_Graph.png")
```


```{r arabic-translation-24,include=FALSE}

example_summary_eng <- calculate_smry_individual(abwave7_eng,"Q101","Algeria")

#English
example_summary_eng %>%
  
  ggplot(aes(x = forcats::fct_rev(haven::as_factor(Q101)),
                               y = Percent),
             fill = ArabBarometer_colors("AB blue")) +
  
  geom_col(fill = ArabBarometer_colors("AB blue")) +
  
  coord_flip() +
  
  scale_x_discrete(labels = function(x) stringr::str_wrap(x,width = 20)) +
  
  scale_y_continuous(limits = c(0,100)) +
  
  geom_text(aes(label = ifelse(Percent == 0, "<1", Percent),
                family = 'Montserrat'),
            size = 6,
            hjust = -1,
            color = ArabBarometer_colors("text grey")) +
  
  labs(title    = "Current economic situation in the country",
       subtitle = "% saying very good or good",
       caption  = "Arab Barometer Wave VII, Algeria (2022)") +
  
  theme_ab_english()

# Arabic

Algeria <- get_countries(abwave7_ara)[1]
example_summary_ara <- calculate_smry_individual(abwave7_ara,"Q101",Algeria)

example_summary_ara %>%
  
  ggplot(aes(x = forcats::fct_rev(haven::as_factor(Q101)),
             y = Percent),
             fill = ArabBarometer_colors("AB blue")) +

  geom_col(fill = ArabBarometer_colors("AB blue")) +
  
  scale_x_discrete(position = "top",
                   labels = function(x) stringr::str_wrap(x,width = 20)) +
  
  scale_y_reverse(limits = c(100,0)) +
  
  coord_flip() +
  
  geom_text(aes(label = ifelse(Percent==0, "1>", Percent),
                family = 'Tajawal'),
            size = 6,
            hjust = 1.5,
            color = ArabBarometer_colors("text grey")) +
  
  labs(title    = "الوضع الاقتصادي العام في بلدك حاليا",
       subtitle = paste("من يقولون إنه جيد جدا أو جيد","%"),
       caption  = paste("2022","الباروميتر العربي")
       ) +

      theme_ab_arabic()


```

<!--chapter:end:arabic-translation.Rmd-->

